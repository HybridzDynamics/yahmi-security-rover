<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map - Surveillance Car</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fas fa-shield-alt"></i>
            <span>Surveillance Car</span>
        </div>
        <div class="nav-menu">
            <a href="index.html" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="wifi-config.html" class="nav-link"><i class="fas fa-wifi"></i> WiFi Config</a>
            <a href="settings.html" class="nav-link"><i class="fas fa-cog"></i> Settings</a>
            <a href="logs.html" class="nav-link"><i class="fas fa-file-alt"></i> Logs</a>
            <a href="map.html" class="nav-link active"><i class="fas fa-map"></i> Map</a>
            <a href="detections.html" class="nav-link"><i class="fas fa-eye"></i> Detections</a>
        </div>
    </nav>

    <main class="main-content">
        <section class="section">
            <div class="section-header">
                <h2><i class="fas fa-map"></i> Live Map</h2>
                <div>
                    <button id="centerBtn" class="btn btn-secondary"><i class="fas fa-crosshairs"></i> Center</button>
                    <button id="refreshBtn" class="btn btn-secondary"><i class="fas fa-sync"></i> Refresh</button>
                </div>
            </div>
            <div id="map" style="height: 70vh; border-radius: 8px; overflow: hidden;"></div>
        </section>
    </main>

    <script>
    let map, marker;
    function initMap() {
        map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        marker = L.marker([0,0]).addTo(map);
    }

    async function fetchLocation() {
        try {
            // If device publishes GPS via server, fetch from status
            const res = await fetch('/api/status');
            const status = await res.json();
            const lat = status?.location?.lat ?? status?.gps?.lat;
            const lng = status?.location?.lng ?? status?.gps?.lng;
            if (typeof lat === 'number' && typeof lng === 'number') {
                marker.setLatLng([lat, lng]);
                return [lat, lng];
            }
        } catch {}
        return null;
    }

    document.getElementById('centerBtn').addEventListener('click', async () => {
        const pos = await fetchLocation();
        if (pos) map.setView(pos, 16);
    });
    document.getElementById('refreshBtn').addEventListener('click', fetchLocation);

    initMap();
    fetchLocation();
    </script>
</body>
</html>


